# Safe Alembic Migrations Guide

This guide explains how to use the safe migration utilities that are automatically included in every Alembic migration file.

## Overview

The Alembic migration template (`alembic/script.py.mako`) has been enhanced to automatically include helper functions that prevent common deployment issues like:

- Creating tables that already exist
- Dropping tables that don't exist
- Creating indexes that already exist
- Dropping indexes that don't exist

## Available Safe Functions

Every generated migration file now includes these helper functions:

### Table Operations

```python
# Check if table exists
table_exists('table_name') -> bool

# Create table only if it doesn't exist
safe_create_table('table_name', column_definitions...)

# Drop table only if it exists
safe_drop_table('table_name')
```

### Index Operations

```python
# Check if index exists
index_exists('index_name', 'table_name') -> bool

# Create index only if it doesn't exist
safe_create_index('index_name', 'table_name', ['column1', 'column2'])

# Drop index only if it exists
safe_drop_index('index_name', 'table_name')
```

## Usage Examples

### Before (Unsafe - can cause deployment failures)

```python
def upgrade() -> None:
    # This will fail if table already exists
    op.create_table('user_session',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        # ... more columns
    )
    op.create_index('ix_user_session_token', 'user_session', ['session_token'])

def downgrade() -> None:
    # This will fail if table doesn't exist
    op.drop_index('ix_user_session_token', table_name='user_session')
    op.drop_table('user_session')
```

### After (Safe - handles existing/missing objects gracefully)

```python
def upgrade() -> None:
    # Option 1: Use safe wrapper functions
    safe_create_table('user_session',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        # ... more columns
    )
    safe_create_index('ix_user_session_token', 'user_session', ['session_token'])

    # Option 2: Use conditional checks
    if not table_exists('user_session'):
        op.create_table('user_session',
            sa.Column('id', sa.Integer(), nullable=False),
            sa.Column('user_id', sa.Integer(), nullable=False),
            # ... more columns
        )
        op.create_index('ix_user_session_token', 'user_session', ['session_token'])

def downgrade() -> None:
    safe_drop_index('ix_user_session_token', 'user_session')
    safe_drop_table('user_session')
```

## Automatic Generation

When you run `alembic revision --autogenerate -m "Your message"`, the generated migration file will automatically include all the safe functions. You just need to:

1. **Replace `op.create_table()` with `safe_create_table()`**
2. **Replace `op.drop_table()` with `safe_drop_table()`**
3. **Replace `op.create_index()` with `safe_create_index()`**
4. **Replace `op.drop_index()` with `safe_drop_index()`**

## Benefits

✅ **Prevents deployment failures** due to existing tables/indexes
✅ **Handles partial migrations** gracefully
✅ **Supports multiple environments** with different states
✅ **Provides clear logging** when skipping operations
✅ **Maintains migration reversibility**

## Migration Workflow

1. **Generate migration**: `alembic revision --autogenerate -m "Add new feature"`
2. **Review generated file**: Check the migration commands
3. **Replace unsafe operations**: Use `safe_*` functions instead of `op.*` functions
4. **Test locally**: Run `alembic upgrade head`
5. **Deploy safely**: Migration will handle existing objects gracefully

## Example: Converting Auto-Generated Migration

```python
# Generated by Alembic (unsafe)
def upgrade() -> None:
    op.create_table('demo_session',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_date', sa.Date(), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_demo_session_date', 'demo_session', ['session_date'])

# Manual conversion (safe)
def upgrade() -> None:
    safe_create_table('demo_session',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('session_date', sa.Date(), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    safe_create_index('ix_demo_session_date', 'demo_session', ['session_date'])
```

## Notes

- The safe functions will print informative messages when skipping operations
- All functions work with both local and production databases
- These functions are automatically included in every new migration file
- Existing migration files will need to be manually updated if needed
